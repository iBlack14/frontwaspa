"use strict";(()=>{var e={};e.id=333,e.ids=[333],e.modules={92885:e=>{e.exports=require("@supabase/supabase-js")},62113:e=>{e.exports=require("next-auth/next")},20145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},99648:e=>{e.exports=import("axios")},56249:(e,t)=>{Object.defineProperty(t,"l",{enumerable:!0,get:function(){return function e(t,s){return s in t?t[s]:"then"in t&&"function"==typeof t.then?t.then(t=>e(t,s)):"function"==typeof t&&"default"===s?t:void 0}}})},80577:(e,t,s)=>{s.a(e,async(e,a)=>{try{s.r(t),s.d(t,{config:()=>d,default:()=>l,routeModule:()=>p});var r=s(71802),n=s(47153),i=s(56249),o=s(62713),u=e([o]);o=(u.then?(await u)():u)[0];let l=(0,i.l)(o,"default"),d=(0,i.l)(o,"config"),p=new r.PagesAPIRouteModule({definition:{kind:n.x.PAGES_API,page:"/api/instances",pathname:"/api/instances",bundlePath:"",filename:""},userland:o});a()}catch(e){a(e)}})},15512:(e,t,s)=>{s.r(t),s.d(t,{authOptions:()=>p,default:()=>c});let a=require("next-auth");var r=s.n(a);let n=require("next-auth/providers/credentials");var i=s.n(n);let o=(0,s(92885).createClient)("https://blxk-supabase.1mrj9n.easypanel.host","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyAgCiAgICAicm9sZSI6ICJhbm9uIiwKICAgICJpc3MiOiAic3VwYWJhc2UtZGVtbyIsCiAgICAiaWF0IjogMTY0MTc2OTIwMCwKICAgICJleHAiOiAxNzk5NTM1NjAwCn0.dc_X5iR_VP_qT0zsiyj_I_OZ2T9FtRU2BBNWN8Bu4GE");async function u({email:e,password:t}){let{data:s,error:a}=await o.auth.signInWithPassword({email:e,password:t});if(a)throw Error(a.message||"Error al iniciar sesi\xf3n");let{data:r}=await o.from("profiles").select("username").eq("id",s.user?.id).single();return{jwt:s.session?.access_token||"",user:{id:s.user?.id||"",email:s.user?.email||"",username:r?.username||s.user?.email?.split("@")[0]||""}}}let l=require("next-auth/providers/google");var d=s.n(l);let p={providers:[i()({name:"Sign in with Email",credentials:{email:{label:"Email",type:"text"},password:{label:"Password",type:"password"}},async authorize(e){if(!e)return null;try{let{user:t,jwt:s}=await u({email:e.email,password:e.password});return{id:t.id,jwt:s,username:t.username,email:t.email}}catch(e){return null}}}),d()({clientId:process.env.NEXT_PUBLIC_GOOGLE_CLIENT_ID,clientSecret:process.env.NEXT_PUBLIC_GOOGLE_CLIENT_SECRET,authorization:{params:{prompt:"consent",access_type:"offline",response_type:"code"}}})],session:{strategy:"jwt",maxAge:259200},pages:{signIn:"/login"},callbacks:{jwt:async({token:e,user:t,account:s,profile:a})=>(t&&(e.jwt=t.jwt,e.id=t.id,e.email=t.email,e.username=t.username),s?.provider==="google"&&a&&(e.email=a.email,e.name=a.name,e.picture=a.picture),e),redirect:async({url:e,baseUrl:t})=>e===t||e===`${t}/login`?`${t}/`:e.startsWith(t)?e:t,session:async({session:e,token:t})=>(t&&(e.id=t.id,e.jwt=t.jwt,e.email=t.email,e.username=t.username),e)}},c=r()(p)},62713:(e,t,s)=>{s.a(e,async(e,a)=>{try{s.r(t),s.d(t,{default:()=>l});var r=s(92618),n=s(99648),i=s(62113),o=s(15512),u=e([n]);async function l(e,t){let{method:s,headers:a,body:u,query:l}=e;process.env.NEXT_PUBLIC_STRAPI_URL,process.env.NEXT_PUBLIC_BACKEND_READ_TOKEN,process.env.NEXT_PUBLIC_BACKEND_UPDATE_INSTANCE_TOKEN;let d=await (0,i.getServerSession)(e,t,o.authOptions);if(!d||!d.id)return t.status(401).json({error:"No autorizado - Inicia sesi\xf3n",sessionExists:!!d,hasId:!!d?.id});try{if("GET"===s){let{data:e,error:s}=await r.p.from("instances").select("*").eq("user_id",d.id).order("created_at",{ascending:!1});if(s)return t.status(500).json({error:s.message});return t.status(200).json({instances:e})}if("POST"===s){let{data:e}=await r.p.from("profiles").select("status_plan").eq("id",d.id).single();if(!e||!1===e.status_plan)return t.status(400).json({message:"No tienes un plan activo"});let s=`${d.id}-${Date.now()}`,a=await n.default.post("https://blxk-n8n.1mrj9n.easypanel.host/webhook/create-instance",{clientId:s,userId:d.id},{headers:{"Content-Type":"application/json"}});return t.status(200).json({success:!0,message:"Instancia creada exitosamente",clientId:s,data:a.data})}if("PUT"===s){let s=await (0,i.getServerSession)(e,t,o.authOptions);if(!s||!s.id)return t.status(401).json({error:"No autorizado - Inicia sesi\xf3n"});let{data:a}=await r.p.from("profiles").select("status_plan").eq("id",s.id).single();if(!a||!1===a.status_plan)return t.status(400).json({message:"No tienes un plan activo"});let{documentId:d}=l,{data:p,error:c}=await r.p.from("instances").update(u.data).eq("document_id",d).eq("user_id",s.id).select().single();if(c)return t.status(500).json({error:c.message});let m=u.data?.webhook_url;if(void 0===m)return t.status(200).json({data:p});return await n.default.post(`http://localhost:4000/api/update-weebhook/${d}`,{webhook_url:m},{headers:{"Content-Type":"application/json"}}),t.status(200).json({data:p})}return t.status(405).json({error:"Method not allowed"})}catch(e){return t.status(500).json({error:e.message}),t.status(e.response?.status||500).json({error:e.response?.data?.message||e.response?.data?.error||e.message||"Internal Server Error",details:e.response?.data})}}n=(u.then?(await u)():u)[0],a()}catch(e){a(e)}})},92618:(e,t,s)=>{s.d(t,{p:()=>a});let a=(0,s(92885).createClient)("https://blxk-supabase.1mrj9n.easypanel.host",process.env.SUPABASE_SERVICE_ROLE_KEY,{auth:{autoRefreshToken:!1,persistSession:!1}})},47153:(e,t)=>{var s;Object.defineProperty(t,"x",{enumerable:!0,get:function(){return s}}),function(e){e.PAGES="PAGES",e.PAGES_API="PAGES_API",e.APP_PAGE="APP_PAGE",e.APP_ROUTE="APP_ROUTE"}(s||(s={}))},71802:(e,t,s)=>{e.exports=s(20145)}};var t=require("../../webpack-api-runtime.js");t.C(e);var s=t(t.s=80577);module.exports=s})();