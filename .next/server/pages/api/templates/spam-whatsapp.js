"use strict";(()=>{var e={};e.id=62,e.ids=[62],e.modules={92885:e=>{e.exports=require("@supabase/supabase-js")},62113:e=>{e.exports=require("next-auth/next")},20145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},6302:e=>{e.exports=require("xlsx")},99648:e=>{e.exports=import("axios")},36705:e=>{e.exports=import("formidable")},57147:e=>{e.exports=require("fs")},56249:(e,t)=>{Object.defineProperty(t,"l",{enumerable:!0,get:function(){return function e(t,a){return a in t?t[a]:"then"in t&&"function"==typeof t.then?t.then(t=>e(t,a)):"function"==typeof t&&"default"===a?t:void 0}}})},85684:(e,t,a)=>{a.a(e,async(e,r)=>{try{a.r(t),a.d(t,{config:()=>c,default:()=>u,routeModule:()=>p});var s=a(71802),n=a(47153),i=a(56249),o=a(23738),l=e([o]);o=(l.then?(await l)():l)[0];let u=(0,i.l)(o,"default"),c=(0,i.l)(o,"config"),p=new s.PagesAPIRouteModule({definition:{kind:n.x.PAGES_API,page:"/api/templates/spam-whatsapp",pathname:"/api/templates/spam-whatsapp",bundlePath:"",filename:""},userland:o});r()}catch(e){r(e)}})},15512:(e,t,a)=>{a.r(t),a.d(t,{authOptions:()=>p,default:()=>m});let r=require("next-auth");var s=a.n(r);let n=require("next-auth/providers/credentials");var i=a.n(n);let o=(0,a(92885).createClient)("https://blxk-supabase.1mrj9n.easypanel.host","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyAgCiAgICAicm9sZSI6ICJhbm9uIiwKICAgICJpc3MiOiAic3VwYWJhc2UtZGVtbyIsCiAgICAiaWF0IjogMTY0MTc2OTIwMCwKICAgICJleHAiOiAxNzk5NTM1NjAwCn0.dc_X5iR_VP_qT0zsiyj_I_OZ2T9FtRU2BBNWN8Bu4GE");async function l({email:e,password:t}){let{data:a,error:r}=await o.auth.signInWithPassword({email:e,password:t});if(r)throw Error(r.message||"Error al iniciar sesi\xf3n");let{data:s}=await o.from("profiles").select("username").eq("id",a.user?.id).single();return{jwt:a.session?.access_token||"",user:{id:a.user?.id||"",email:a.user?.email||"",username:s?.username||a.user?.email?.split("@")[0]||""}}}let u=require("next-auth/providers/google");var c=a.n(u);let p={providers:[i()({name:"Sign in with Email",credentials:{email:{label:"Email",type:"text"},password:{label:"Password",type:"password"}},async authorize(e){if(!e)return null;try{let{user:t,jwt:a}=await l({email:e.email,password:e.password});return{id:t.id,jwt:a,username:t.username,email:t.email}}catch(e){return null}}}),c()({clientId:process.env.NEXT_PUBLIC_GOOGLE_CLIENT_ID,clientSecret:process.env.NEXT_PUBLIC_GOOGLE_CLIENT_SECRET,authorization:{params:{prompt:"consent",access_type:"offline",response_type:"code"}}})],session:{strategy:"jwt",maxAge:259200},pages:{signIn:"/login"},callbacks:{jwt:async({token:e,user:t,account:a,profile:r})=>(t&&(e.jwt=t.jwt,e.id=t.id,e.email=t.email,e.username=t.username),a?.provider==="google"&&r&&(e.email=r.email,e.name=r.name,e.picture=r.picture),e),redirect:async({url:e,baseUrl:t})=>e===t||e===`${t}/login`?`${t}/`:e.startsWith(t)?e:t,session:async({session:e,token:t})=>(t&&(e.id=t.id,e.jwt=t.jwt,e.email=t.email,e.username=t.username),e)}},m=s()(p)},23738:(e,t,a)=>{a.a(e,async(e,r)=>{try{a.r(t),a.d(t,{config:()=>y,default:()=>f});var s=a(92618),n=a(62113),i=a(15512),o=a(36705),l=a(6302),u=a.n(l),c=a(57147),p=a.n(c),m=a(99648),d=a(73849),g=e([o,m]);[o,m]=g.then?(await g)():g;let y={api:{bodyParser:!1}};async function f(e,t){if("POST"!==e.method)return t.status(405).json({error:"Method not allowed"});try{let a=await (0,n.getServerSession)(e,t,i.authOptions);if(!a||!a.id)return t.status(401).json({error:"No autorizado"});let{data:r}=await s.p.from("profiles").select("status_plan, api_key").eq("id",a.id).single();if(!r||!r.status_plan)return t.status(403).json({error:"No tienes un plan activo"});let l=(0,o.default)({multiples:!1}),[c,g]=await new Promise((t,a)=>{l.parse(e,(e,r,s)=>{e&&a(e),t([r,s])})}),f=Array.isArray(c.instanceId)?c.instanceId[0]:c.instanceId,y=Array.isArray(c.message)?c.message[0]:c.message,A=Array.isArray(c.imageUrl)?c.imageUrl[0]:c.imageUrl,w=Array.isArray(c.waitTime)?parseInt(c.waitTime[0]):3,I=g.file,j=g.imageFile;if(!f||!I)return t.status(400).json({error:"Faltan campos requeridos"});let _=A||"";if(j)try{let e=Array.isArray(j)?j[0].filepath:j.filepath,t=Array.isArray(j)?j[0].originalFilename:j.originalFilename,r=p().readFileSync(e),n=Date.now(),i=t.split(".").pop(),o=`spam-images/${a.id}/${n}.${i}`,{data:l,error:u}=await s.p.storage.from("public-files").upload(o,r,{contentType:Array.isArray(j)?j[0].mimetype:j.mimetype,upsert:!1});if(u);else{let{data:{publicUrl:e}}=s.p.storage.from("public-files").getPublicUrl(o);_=e}p().unlinkSync(e)}catch(e){}let{data:b}=await s.p.from("instances").select("document_id, state").eq("document_id",f).eq("user_id",a.id).single();if(!b)return t.status(404).json({error:"Instancia no encontrada"});if("Connected"!==b.state)return t.status(400).json({error:"La instancia no est\xe1 conectada",message:"Por favor, reconecta tu instancia de WhatsApp y escanea el QR antes de enviar mensajes.",instanceState:b.state});let P="http://localhost:4000";if(!P)return t.status(500).json({error:"Backend de WhatsApp no configurado",message:"Contacta al administrador"});try{await m.default.get(`${P}/api/sessions`,{timeout:5e3})}catch(e){return t.status(503).json({error:"Backend de WhatsApp no disponible",message:"El servidor de WhatsApp no est\xe1 respondiendo. Intenta m\xe1s tarde."})}let E=Array.isArray(I)?I[0].filepath:I.filepath,C=u().readFile(E),x=C.SheetNames[0],v=C.Sheets[x],S=u().utils.sheet_to_json(v);if(0===S.length||!S[0].hasOwnProperty("numero"))return t.status(400).json({error:'El Excel debe tener una columna llamada "numero"'});let O=S.map(e=>({clientId:f,apiKey:r.api_key,numero:e.numero.toString(),mensaje:e.mensaje||y||"",imagen:e.imagen||_||""})),T=`spam_${a.id}_${Date.now()}`;return(0,d.jg)(T,O.length,a.id),h({spamId:T,contacts:O,instanceId:f,apiKey:r.api_key,waitTime:w,BACKEND_URL:P,finalImageUrl:_}),p().unlinkSync(E),t.json({success:!0,spamId:T,totalContacts:O.length,message:`Iniciando env\xedo a ${O.length} contactos`})}catch(e){t.status(500).json({error:e.message})}}async function h({spamId:e,contacts:t,instanceId:a,apiKey:r,waitTime:s,BACKEND_URL:n,finalImageUrl:i}){try{for(let i=0;i<t.length&&(0,d.bL)(e);i++){let o=t[i];try{let l=!!o.imagen,u=l?`${n}/api/send-image/${a}`:`${n}/api/send-message/${a}`,c=l?{number:o.numero,file:o.imagen,message:o.mensaje}:{number:o.numero,message:o.mensaje};if(await m.default.post(u,c,{headers:{Authorization:r,"Content-Type":"application/json"}}),(0,d.RO)(e,i+1,{success:!0,number:o.numero}),i<t.length-1){let t=1e3*s,a=0;for(;a<t;){if(!(0,d.bL)(e))return;await new Promise(e=>setTimeout(e,Math.min(500,t-a))),a+=500}}}catch(t){(0,d.RO)(e,i+1,{success:!1,number:o.numero,error:t.message})}}(0,d.Hd)(e)}catch(t){(0,d.Hd)(e)}}r()}catch(e){r(e)}})},73849:(e,t,a)=>{a.d(t,{Co:()=>p,Hd:()=>l,JE:()=>c,RO:()=>o,b5:()=>u,bL:()=>n,cl:()=>i,jg:()=>s});let r=new Map;function s(e,t,a){return r.set(e,{id:e,userId:a,totalContacts:t,currentContact:0,stopped:!1,completed:!1,startedAt:new Date,errors:[],success:[]}),r.get(e)}function n(e){let t=r.get(e);return!!t&&!t.stopped&&!t.completed}function i(e){let t=r.get(e);t&&(t.stopped=!0,t.stoppedAt=new Date)}function o(e,t,a=null){let s=r.get(e);s&&(s.currentContact=t,s.lastUpdate=new Date,a&&(a.success?s.success.push(a.number):s.errors.push({number:a.number,error:a.error})))}function l(e){let t=r.get(e);t&&(t.completed=!0,t.completedAt=new Date,setTimeout(()=>{r.delete(e)},3e5))}function u(e){return r.get(e)||null}function c(e){let t=[];for(let[a,s]of r.entries())s.userId===e&&t.push(s);return t}function p(e){return!!r.get(e)&&(r.delete(e),!0)}},92618:(e,t,a)=>{a.d(t,{p:()=>r});let r=(0,a(92885).createClient)("https://blxk-supabase.1mrj9n.easypanel.host",process.env.SUPABASE_SERVICE_ROLE_KEY,{auth:{autoRefreshToken:!1,persistSession:!1}})},47153:(e,t)=>{var a;Object.defineProperty(t,"x",{enumerable:!0,get:function(){return a}}),function(e){e.PAGES="PAGES",e.PAGES_API="PAGES_API",e.APP_PAGE="APP_PAGE",e.APP_ROUTE="APP_ROUTE"}(a||(a={}))},71802:(e,t,a)=>{e.exports=a(20145)}};var t=require("../../../webpack-api-runtime.js");t.C(e);var a=t(t.s=85684);module.exports=a})();