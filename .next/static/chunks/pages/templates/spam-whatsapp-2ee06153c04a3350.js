(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[0],{6387:function(e,t,n){(window.__NEXT_P=window.__NEXT_P||[]).push(["/templates/spam-whatsapp",function(){return n(6905)}])},6905:function(e,t,n){"use strict";n.r(t),n.d(t,{default:function(){return x}});var s=n(5893),a=n(3299),r=n(1163),l=n(7294),i=n(1664),c=n.n(i),o=n(7066),d=n(4712),m=n(4139);function u(){let{data:e,status:t}=(0,a.useSession)(),n=(0,r.useRouter)(),[i,m]=(0,l.useState)([]),[u,x]=(0,l.useState)(""),[p,h]=(0,l.useState)(null),[b,g]=(0,l.useState)(""),[f,j]=(0,l.useState)(""),[v,N]=(0,l.useState)(null),[z,y]=(0,l.useState)("none"),[w,E]=(0,l.useState)(3),[C,D]=(0,l.useState)(!1),[S,k]=(0,l.useState)({current:0,total:0}),[I,A]=(0,l.useState)(null),[_,P]=(0,l.useState)(null);(0,l.useEffect)(()=>{"unauthenticated"===t&&n.push("/login")},[t,n]),(0,l.useEffect)(()=>{"authenticated"===t&&F()},[t]),(0,l.useEffect)(()=>{if(!I||!C)return;let e=setInterval(async()=>{try{let t=(await o.Z.get("/api/templates/spam-control?spamId=".concat(I))).data.status;t&&(P(t),k({current:t.currentContact,total:t.totalContacts}),(t.stopped||t.completed)&&(clearInterval(e),D(!1),t.stopped?d.Am.warning("Env\xedo detenido. ".concat(t.success.length," enviados, ").concat(t.errors.length," errores")):d.Am.success("\xa1Completado! ".concat(t.success.length," enviados, ").concat(t.errors.length," errores")),setTimeout(()=>{n.push("/templates")},3e3)))}catch(e){console.error("Error polling spam status:",e)}},1e3);return()=>clearInterval(e)},[I,C,n]);let F=async()=>{try{let e=(await o.Z.get("/api/instances")).data.instances.map(e=>({documentId:e.document_id||e.documentId,state:e.state,phoneNumber:e.phone_number||e.phoneNumber,name:e.profile_name||e.name||"Instancia"})).filter(e=>"Connected"===e.state);m(e),e.length>0&&x(e[0].documentId)}catch(e){console.error("Error fetching instances:",e)}},G=async e=>{if(e.preventDefault(),!u){d.Am.error("Selecciona una instancia conectada");return}if(!p){d.Am.error("Sube un archivo Excel");return}D(!0);try{let e=new FormData;e.append("file",p),e.append("instanceId",u),e.append("message",b),"url"===z&&f?e.append("imageUrl",f):"upload"===z&&v&&e.append("imageFile",v),e.append("waitTime",w.toString());let t=await o.Z.post("/api/templates/spam-whatsapp",e,{headers:{"Content-Type":"multipart/form-data"},onUploadProgress:e=>{if(e.total){let t=Math.round(100*e.loaded/e.total);console.log("Upload progress: ".concat(t,"%"))}}}),n=t.data.spamId;A(n),k({current:0,total:t.data.totalContacts}),d.Am.success("Enviando mensajes a ".concat(t.data.totalContacts," contactos..."))}catch(e){var t,n;console.error("Error:",e),d.Am.error((null===(n=e.response)||void 0===n?void 0:null===(t=n.data)||void 0===t?void 0:t.error)||"Error al enviar mensajes"),D(!1),A(null)}},M=async()=>{if(I)try{await o.Z.post("/api/templates/spam-control",{action:"stop",spamId:I}),d.Am.info("Deteniendo env\xedo...")}catch(e){console.error("Error stopping spam:",e),d.Am.error("Error al detener el env\xedo")}};return"loading"===t?(0,s.jsx)("div",{className:"min-h-screen bg-zinc-950 flex items-center justify-center",children:(0,s.jsx)("div",{className:"text-white",children:"Cargando..."})}):(0,s.jsxs)("div",{className:"min-h-screen bg-zinc-950 text-white",children:[(0,s.jsx)("div",{className:"border-b border-zinc-800 bg-zinc-900/50 backdrop-blur-sm sticky top-0 z-10",children:(0,s.jsx)("div",{className:"max-w-4xl mx-auto px-4 sm:px-6 lg:px-8",children:(0,s.jsx)("div",{className:"flex items-center justify-between h-16",children:(0,s.jsxs)("div",{className:"flex items-center gap-4",children:[(0,s.jsx)(c(),{href:"/templates",className:"text-emerald-500 hover:text-emerald-400 transition",children:"← Volver"}),(0,s.jsx)("h1",{className:"text-2xl font-bold",children:"\uD83D\uDCE8 SPAM WhatsApp"})]})})})}),(0,s.jsx)("div",{className:"max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8",children:(0,s.jsxs)("form",{onSubmit:G,className:"space-y-6",children:[(0,s.jsxs)("div",{className:"bg-zinc-900 border border-zinc-800 rounded-lg p-6",children:[(0,s.jsx)("label",{className:"block text-sm font-medium mb-2",children:"Selecciona tu instancia de WhatsApp"}),0===i.length?(0,s.jsxs)("div",{className:"text-zinc-400 text-sm",children:["No tienes instancias conectadas."," ",(0,s.jsx)(c(),{href:"/instances",className:"text-emerald-500 hover:underline",children:"Conecta una instancia"})]}):(0,s.jsx)("select",{value:u,onChange:e=>x(e.target.value),className:"w-full bg-zinc-800 border border-zinc-700 rounded-md px-4 py-2 focus:outline-none focus:ring-2 focus:ring-emerald-500",children:i.map(e=>(0,s.jsxs)("option",{value:e.documentId,children:[e.name||"Instancia"," - ",e.phoneNumber||"Sin n\xfamero"]},e.documentId))})]}),(0,s.jsxs)("div",{className:"bg-zinc-900 border border-zinc-800 rounded-lg p-6",children:[(0,s.jsx)("label",{className:"block text-sm font-medium mb-2",children:"Sube tu archivo Excel"}),(0,s.jsxs)("p",{className:"text-zinc-400 text-sm mb-4",children:["El Excel debe tener una columna llamada ",(0,s.jsx)("code",{className:"bg-zinc-800 px-2 py-1 rounded",children:"numero"})]}),(0,s.jsxs)("div",{className:"border-2 border-dashed border-zinc-700 rounded-lg p-8 text-center hover:border-emerald-500 transition",children:[(0,s.jsx)("input",{type:"file",accept:".xlsx,.xls",onChange:e=>{if(e.target.files&&e.target.files[0]){let t=e.target.files[0];t.name.endsWith(".xlsx")||t.name.endsWith(".xls")?h(t):d.Am.error("Por favor sube un archivo Excel (.xlsx o .xls)")}},className:"hidden",id:"excel-upload"}),(0,s.jsxs)("label",{htmlFor:"excel-upload",className:"cursor-pointer",children:[(0,s.jsx)("div",{className:"text-4xl mb-2",children:"\uD83D\uDCCE"}),p?(0,s.jsx)("p",{className:"text-emerald-500",children:p.name}):(0,s.jsx)("p",{className:"text-zinc-400",children:"Click para subir o arrastra aqu\xed"})]})]})]}),(0,s.jsxs)("div",{className:"bg-zinc-900 border border-zinc-800 rounded-lg p-6",children:[(0,s.jsx)("label",{className:"block text-sm font-medium mb-2",children:"Mensaje (opcional)"}),(0,s.jsx)("textarea",{value:b,onChange:e=>g(e.target.value),placeholder:"Escribe tu mensaje aqu\xed...",rows:4,className:"w-full bg-zinc-800 border border-zinc-700 rounded-md px-4 py-2 focus:outline-none focus:ring-2 focus:ring-emerald-500"})]}),(0,s.jsxs)("div",{className:"bg-zinc-900 border border-zinc-800 rounded-lg p-6",children:[(0,s.jsx)("label",{className:"block text-sm font-medium mb-4",children:"Imagen (opcional)"}),(0,s.jsxs)("div",{className:"flex gap-4 mb-4",children:[(0,s.jsx)("button",{type:"button",onClick:()=>{y("none"),j(""),N(null)},className:"flex-1 py-2 px-4 rounded-md transition ".concat("none"===z?"bg-emerald-600 text-white":"bg-zinc-800 text-zinc-400 hover:bg-zinc-700"),children:"Sin imagen"}),(0,s.jsx)("button",{type:"button",onClick:()=>y("url"),className:"flex-1 py-2 px-4 rounded-md transition ".concat("url"===z?"bg-emerald-600 text-white":"bg-zinc-800 text-zinc-400 hover:bg-zinc-700"),children:"URL"}),(0,s.jsx)("button",{type:"button",onClick:()=>y("upload"),className:"flex-1 py-2 px-4 rounded-md transition ".concat("upload"===z?"bg-emerald-600 text-white":"bg-zinc-800 text-zinc-400 hover:bg-zinc-700"),children:"Subir archivo"})]}),"url"===z&&(0,s.jsx)("div",{children:(0,s.jsx)("input",{type:"url",value:f,onChange:e=>j(e.target.value),placeholder:"https://ejemplo.com/imagen.png",className:"w-full bg-zinc-800 border border-zinc-700 rounded-md px-4 py-2 focus:outline-none focus:ring-2 focus:ring-emerald-500"})}),"upload"===z&&(0,s.jsxs)("div",{className:"border-2 border-dashed border-zinc-700 rounded-lg p-6 text-center hover:border-emerald-500 transition",children:[(0,s.jsx)("input",{type:"file",accept:"image/jpeg,image/jpg,image/png,image/gif,image/webp",onChange:e=>{if(e.target.files&&e.target.files[0]){let t=e.target.files[0];["image/jpeg","image/jpg","image/png","image/gif","image/webp"].includes(t.type)?t.size<=5242880?(N(t),j("")):d.Am.error("La imagen debe ser menor a 5MB"):d.Am.error("Formato de imagen no v\xe1lido. Usa JPG, PNG, GIF o WebP")}},className:"hidden",id:"image-upload"}),(0,s.jsxs)("label",{htmlFor:"image-upload",className:"cursor-pointer",children:[(0,s.jsx)("div",{className:"text-4xl mb-2",children:"\uD83D\uDDBC️"}),v?(0,s.jsxs)("div",{children:[(0,s.jsx)("p",{className:"text-emerald-500 mb-1",children:v.name}),(0,s.jsxs)("p",{className:"text-zinc-400 text-xs",children:[(v.size/1024).toFixed(2)," KB"]})]}):(0,s.jsxs)("div",{children:[(0,s.jsx)("p",{className:"text-zinc-400",children:"Click para subir o arrastra aqu\xed"}),(0,s.jsx)("p",{className:"text-zinc-500 text-xs mt-1",children:"JPG, PNG, GIF, WebP (m\xe1x. 5MB)"})]})]})]})]}),(0,s.jsxs)("div",{className:"bg-zinc-900 border border-zinc-800 rounded-lg p-6",children:[(0,s.jsx)("h3",{className:"text-lg font-semibold mb-4",children:"⚙️ Configuraci\xf3n Avanzada"}),(0,s.jsxs)("div",{children:[(0,s.jsx)("label",{className:"block text-sm font-medium mb-2",children:"Espera entre mensajes (segundos)"}),(0,s.jsx)("input",{type:"number",min:"1",max:"60",value:w,onChange:e=>E(parseInt(e.target.value)),className:"w-full bg-zinc-800 border border-zinc-700 rounded-md px-4 py-2 focus:outline-none focus:ring-2 focus:ring-emerald-500"}),(0,s.jsx)("p",{className:"text-zinc-400 text-xs mt-1",children:"Recomendado: 3-5 segundos para evitar bloqueos"})]})]}),(0,s.jsx)("div",{className:"flex gap-4",children:C?(0,s.jsx)("button",{type:"button",onClick:M,className:"w-full bg-red-600 hover:bg-red-700 text-white py-3 px-6 rounded-md transition font-bold flex items-center justify-center gap-2",children:"\uD83D\uDED1 DETENER ENV\xcdO"}):(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)("button",{type:"button",onClick:()=>n.push("/templates"),className:"flex-1 bg-zinc-800 hover:bg-zinc-700 text-white py-3 px-6 rounded-md transition",children:"Cancelar"}),(0,s.jsx)("button",{type:"submit",disabled:C||!p||0===i.length,className:"flex-1 bg-emerald-600 hover:bg-emerald-700 text-white py-3 px-6 rounded-md transition disabled:opacity-50 disabled:cursor-not-allowed",children:"Iniciar Env\xedo \uD83D\uDE80"})]})}),C&&S.total>0&&(0,s.jsxs)("div",{className:"bg-zinc-900 border border-zinc-800 rounded-lg p-6",children:[(0,s.jsxs)("div",{className:"flex justify-between mb-2",children:[(0,s.jsx)("span",{className:"font-semibold",children:"Progreso del Env\xedo"}),(0,s.jsxs)("span",{className:"font-mono",children:[S.current," / ",S.total]})]}),(0,s.jsx)("div",{className:"w-full bg-zinc-800 rounded-full h-4 mb-4 overflow-hidden",children:(0,s.jsxs)("div",{className:"bg-gradient-to-r from-emerald-500 to-emerald-600 h-4 rounded-full transition-all duration-500 flex items-center justify-center text-xs text-white font-bold",style:{width:"".concat(S.total>0?S.current/S.total*100:0,"%")},children:[S.total>0&&Math.round(S.current/S.total*100),"%"]})}),_&&(0,s.jsxs)("div",{className:"grid grid-cols-3 gap-4 text-center",children:[(0,s.jsxs)("div",{className:"bg-zinc-800 p-3 rounded",children:[(0,s.jsx)("div",{className:"text-2xl font-bold text-emerald-500",children:_.success.length}),(0,s.jsx)("div",{className:"text-xs text-zinc-400",children:"Exitosos"})]}),(0,s.jsxs)("div",{className:"bg-zinc-800 p-3 rounded",children:[(0,s.jsx)("div",{className:"text-2xl font-bold text-red-500",children:_.errors.length}),(0,s.jsx)("div",{className:"text-xs text-zinc-400",children:"Errores"})]}),(0,s.jsxs)("div",{className:"bg-zinc-800 p-3 rounded",children:[(0,s.jsx)("div",{className:"text-2xl font-bold text-blue-500",children:S.total-S.current}),(0,s.jsx)("div",{className:"text-xs text-zinc-400",children:"Pendientes"})]})]}),(0,s.jsx)("div",{className:"mt-4 text-center",children:(0,s.jsx)("p",{className:"text-zinc-400 text-sm",children:(null==_?void 0:_.stopped)?"\uD83D\uDED1 Env\xedo detenido por el usuario":(null==_?void 0:_.completed)?"✅ Env\xedo completado":"⏳ Enviando mensajes..."})})]})]})})]})}function x(){return(0,s.jsxs)(m.default,{children:[(0,s.jsx)(u,{}),(0,s.jsx)(d.x7,{position:"top-right"})]})}},1163:function(e,t,n){e.exports=n(6036)}},function(e){e.O(0,[141,675,261,712,139,888,774,179],function(){return e(e.s=6387)}),_N_E=e.O()}]);